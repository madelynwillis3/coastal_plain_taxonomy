---
title: "ch3_Perry_cluster_modelling_NCSS"
format: html
---

```{r}
#libraries:
library(dplyr)
library(tidyr)
library(stringr)
```

```{r}
#Pull data:

#NCSS data:

    #pedon, taxonomic name and series name: 
    ncss_pedon <- read.csv("../data/Pedon_all_SCP_MLRA.csv") #siteobsiiref is pedon id
    
    #horizon name, seq, top depth, bottom depth, some texture:
    ncss_phorizon <- read.csv("../data/ncss_phorizon.csv") #peiidref is pedon id (multiples per pedon)
  
    #color per horizon, hue value, chroma:
    ncss_color <- read.csv("../data/ncss_phcolor.csv") #phiidref is pedon id
    
    #mottles present per hz, HVC and percentage:
    ncss_mottles <- read.csv("../data/ncss_pmottles.csv") #phiidref is pedon id
    
    #lab data: CEC
    ncss_labdata <- read.csv("../data/ncss_labdata.csv") #ncsslabdataiidref is pedon id , seq is hz 
    
    # str(ncss_pedon)
    # str(ncss_phorizon)
    # str(ncss_color)
    # str(ncss_mottles)
    # str(ncss_labdata)
    
    # --- 1) pedon -> horizon join (pedon id key is peiid <-> peiidref) ---
      # Pedons you want to keep (your MLRA-clipped set)
      keep_peiid <- ncss_pedon %>%
        distinct(peiid)
      
      # Horizons that belong to those pedons (also gives you the horizon ids)
      keep_hz <- ncss_phorizon %>%
        semi_join(keep_peiid, by = c("peiidref" = "peiid")) %>%
        distinct(peiidref, phiid)
      
      keep_phiid <- keep_hz %>% distinct(phiid)
    
      ncss_phorizon_mlra <- ncss_phorizon %>%
      semi_join(keep_peiid, by = c("peiidref" = "peiid"))

      ncss_color_mlra <- ncss_color %>%
      semi_join(keep_phiid, by = c("phiidref" = "phiid"))
    
      ncss_mottles_mlra <- ncss_mottles %>%
      semi_join(keep_phiid, by = c("phiidref" = "phiid"))

      keep_labsamp <- ncss_pedon %>%
      distinct(pedlabsampnum) %>%
      filter(!is.na(pedlabsampnum), pedlabsampnum != "")
    
      ncss_labdata_mlra <- ncss_labdata %>%
      semi_join(keep_labsamp, by = c("labsampnum" = "pedlabsampnum"))

    # --- 2a) summarize colors per horizon ---

    
    color_summ <- ncss_color_mlra %>%
      mutate(color = str_trim(paste(colorhue, colorvalue, "/", colorchroma))) %>%
      group_by(phiidref) %>%
      summarise(
        # keep a compact list of distinct colors
        colors = paste(unique(na.omit(color)), collapse = "; "))

    
    # --- 2b) summarize mottles per horizon ---

    mottle_summ <- ncss_mottles_mlra %>%
      mutate(mottle_color = str_trim(paste(colorhue, colorvalue, "/", colorchroma))) %>%
      group_by(phiidref) %>%
      summarise(
        mottles = paste(
          unique(na.omit(
            paste0(
              ifelse(is.na(mottlepct), "", paste0(mottlepct, "% ")),
              mottlecntrst, " ", mottlesize, " ",
              mottle_color,
              ifelse(is.na(mottleloc) | mottleloc == "", "", paste0(" (", mottleloc, ")"))
            )
          )),
          collapse = "; "
        ),
        .groups = "drop"
      )
    
    # --- 2c) join onto horizon master ---

    hz_master2 <- hz_master %>%
      left_join(color_summ,  by = c("phiid" = "phiidref")) %>%
      left_join(mottle_summ, by = c("phiid" = "phiidref"))

    # 3C)
    lab_keep <- ncss_labdata_mlra %>%
      select(labsampnum, layerseqnum, hzdept, hzdepb,
             cec7, ecec, cecsumcations, sumbases, basesatnh4oac, basesatsumcations)
    
    hz_master3 <- hz_master2 %>%
      left_join(
        lab_keep,
        by = c("pedlabsampnum" = "labsampnum", "seqnum" = "layerseqnum")
      )

#Perry data:
  #data to keep: hz name, seq, top depth, bottom depth, txt class, txt percentages (test), Hue, Value, Chroma, and mottle HVC and percentages
```

